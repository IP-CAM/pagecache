# octurbo 

pagecache - A page level cache for opencart
 

## VERSION

Version 1.00

## DESCRIPTION

This page cahce is part of a collection of code intended to help improve the performance and funtionality of opencart.

At the moment, these improvements consist of a simple, but effective, page level cache for opencart.  It's very simple to install, consisting only of one new file, and 2 minor changes you'll make to the index.php file in your home directory.

## Installation

Two simple steps.

- Copy the pagecache.php to the system/library directory of your opencart installation.
- Read the 'index.php.changes' file, and make the two changes to your index.php file


## OVERVIEW
Very early in the index.php, the following lines of code have been added to index.php:
 
    require_once(DIR_SYSTEM . 'library/pagecache.php');
    $pagecache = new PageCache();
    if ($pagecache->ServeFromCache()) {
        // exit here if we served this page from the cache;
        return;
    }

This section of code looks to see if there's a previously cached file for the url that's currently being requested.  If there is, and it's not expired, the request is served from the cache.  Because this is very early in the index.php file, and because it exits if served from the cache (via the return() call), it skips over almost all of the processing that opencart normally does.  No database calls, etc..so it's very fast.

Later, towards the end of the index.php, the following lines of code have been added.  This is very near the end of the file, after whatever page was requested has already been generated by opencart, and served to the end user. 

    // if this page is ok to cache, but not yet in the cache,
    // then try to save it to the page cache
    if ($pagecache->OkToCache()) {
       $pagecache->CachePage($response);
    }

Here, we're seeing if we should take the page that opencart just generated and cache it.  This does add a small amount of overhead in writing out the content twice (once to the browser, and once to the cache file).  That is, however, the only notable overhead added, and it's quite minimal.  

## SETTINGS

In order to keep this page cache lightweight, we do not store settings in the opencart database like a normal opencart extension would.  This allows a cached page to be served with almost no opencart code running, and no database calls at all.  Therefore, to make changes to settings, you have to hand edit the pagecache.php file.  Here's the settings you can safely change:

     
    // These are all near the top of the pagecache.php file  
    private $expire='14400'   ; // expire time, in seconds 14400 = 4 hours
    private $lang='en'        ; // default language for site
    private $currency='USD'   ; // default currency for site
    private $addcomment = true; // set to true to add a comment to the bottom
                                // of cached pages with info and expire time
    private $skip_urls= array('#checkout/#','#product/compare#');


A new notes on these settings:

- $expire : Because it's in the declaration section of the class, your options to set this are limited...you can't, for example, do $expire=24*24*60.  Just figure out the number of seconds you want cached pages to exist before they expire. We used 14400, which is 4 hours.
- $lang and $currency : We cache pages for different languages and currencies in different files.  These two settings control what the default language and/or currency is if we get an http request that does not have the session variable(s) for each respective setting already set.
- $addcomment : Set to true if you want the page cache to append an html comment at the end of the stored cache file that notes the url cached and it's expiry time.  This can be helpful since you can see it with live pages via your browser's "view source" functionality.  Set to false if you don't want this.  Note that this can create problems if you choose to cache, for example, JSON pages.  An thml comment at the end of some JSON will create runtime javascript errors.
- $skip_urls : This is an array of PCRE patterns for urls that you do not want to be cached.  The default settings will not cache any page with the string 'checkout/' or 'product/compare' in it's url.  Not that this is not the only check done to decide when a page shoudn't be cached.  You don't have to, for example, mark the 'account/' pages here, because we already disable caching when a user is logged in.

## DEMO


We created demo site at [octurbo.com](http://octurbo.com).  The home page has links to both a stock/vanilla installation of opencart, and one with our page cache.  Note that you may have to load a page from the pagecache enabled site first...to get it into the cache.  The cache expires every 4 hours.  Since the vanillaopencart install doesn't have a lot of categories and products, there's not a HUGE difference when you measure load times.  From our vantage point on the network, the cached version of the page downloads about twice as fast as the vanilla page (that's just the html of the page...not including all the images, css, etc). 
A page cache makes a much bigger difference on an opencart site that has a lot or products, categories, and other functionality.  You can also try our production site, [budgetneon.com](http://budgetneon.com/), which has lots of products and nested categories.  If you view the source of a cached page, you'll see the html comment at the bottom.

## CAVEATS

- The page cache does not check the sanity of url parameters. So, it will happily cache '/index.php?foo=1', '/index.php?foo=2', and so on...all as separate urls and cache file.  This could result in a very large number of cached pages, and in extreme circumstances (like a robot crawling invalid pages), it could potentially fill up your hard drive.

- We did try to put in sufficient logic such that dynamically created pages that should not be cached...aren't.  However, it's possible we missed some.  Also, if you've added extensions to opencart that have url's that shouldn't be cached, that will likely be missed.  See the "$skip_urls" setting to remedy that.

- A page cache can be a terrible crutch, that effectively hides important performance problems.  For example, if your home page is really slow, the first person to request the page when it's not cached (or when the cache expires) will see that horrible performance.  Subsequent visits will get the benefit of the page cache, which is nice...but not if that's hiding the true issue from the site owner.  In short, it's not a substitute for proper performance tuning.

## AUTHOR

Kerry Schwab, `<sales at budgetneon.com>`

We run [BudgetNeon.com](http://budgetneon.com/).  The website uses opencart, and this code was written specifically to support our website. We sell [neon open signs](http://budgetneon.com/open-signs), signs for [restaurants](http://budgetneon.com/restaraunt) and [businesses](http://budgetneon.com/business, as well as [custom made neon](http://budgetneon.com/custom).  We plan to release more our local opencart additions, especially those that improve performance.

## LICENSE AND COPYRIGHT

Copyright (c) 2014 Kerry Schwab & BudgetNeon.com
All rights reserved.

This program is free software; you can redistribute it and/or modify it
under the terms of the the FreeBSD License . You may obtain a
copy of the full license at:

[http://www.freebsd.org/copyright/freebsd-license.html](http://www.freebsd.org/copyright/freebsd-license.html)


Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

- Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
- Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
- Neither the name of the organization nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> BE LIABLE FOR ANY
DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
